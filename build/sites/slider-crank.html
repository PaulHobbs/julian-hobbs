<!DOCTYPE html>
<html>
<head>
    <title>Matter.js Slider-Crank Linkage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            font-family: sans-serif;
        }
        canvas {
            border: 1px solid #333;
            background-color: #fff;
        }
        .info {
            margin-top: 10px;
            color: #333;
            font-size: 14px;
        }
        .info span {
            font-weight: bold;
            color: #d9534f; /* Color to match the crank or a visible element */
        }
    </style>
</head>
<body>
    <div class="info">
        Click and drag the <span id="crank-color" style="color: #4CAF50;">Green Crank</span> to interact.
    </div>
    <script>
        // Matter.js Module Aliases
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Body = Matter.Body,
              Bodies = Matter.Bodies,
              Constraint = Matter.Constraint,
              MouseConstraint = Matter.MouseConstraint,
              Mouse = Matter.Mouse,
              World = Matter.World,
              Events = Matter.Events;

        // --- Configuration ---
        const WIDTH = 800;
        const HEIGHT = 600;
        const PIVOT_X = 200; // X position of the fixed crank pivot
        const PIVOT_Y = 300; // Y position of the fixed crank pivot (centerline)
        const CRANK_RADIUS = 50;
        const CONNECTING_ROD_LENGTH = 250;
        const CONNECTING_ROD_THICKNESS = 10;
        const SLIDER_WIDTH = 60;
        const SLIDER_HEIGHT = 40;
        const SLIDER_Y = PIVOT_Y; // The slider must move along the centerline

        // --- Setup Matter.js Engine and Renderer ---
        const engine = Engine.create({
            gravity: { x: 0, y: 0 } // No gravity for a mechanism simulation
        });
        const world = engine.world;

        const render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: WIDTH,
                height: HEIGHT,
                wireframes: false, // Set to true to see the raw physics bodies
                background: '#fafafa'
            }
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // --- Create Bodies (Links) ---

        // 1. Fixed Pivot (Ground Link)
        const pivot = Bodies.circle(PIVOT_X, PIVOT_Y, 5, {
            isStatic: true,
            label: 'Pivot',
            render: { fillStyle: '#333' }
        });

        // 2. Crank (Rotating Link)
        const crank = Bodies.rectangle(PIVOT_X + CRANK_RADIUS, PIVOT_Y, CRANK_RADIUS * 2, 10, {
            density: 0.01,
            frictionAir: 0.05,
            label: 'Crank',
            render: { fillStyle: '#4CAF50' } // Green
        });

        // 3. Connecting Rod (Coupler Link)
        const connectingRod = Bodies.rectangle(PIVOT_X + CRANK_RADIUS + CONNECTING_ROD_LENGTH / 2, PIVOT_Y, CONNECTING_ROD_LENGTH, CONNECTING_ROD_THICKNESS, {
            density: 0.005,
            label: 'ConnectingRod',
            render: { fillStyle: '#5BC0DE' } // Blue
        });

        // 4. Slider (Piston/Prismatic Link)
        const slider = Bodies.rectangle(PIVOT_X + CRANK_RADIUS + CONNECTING_ROD_LENGTH, SLIDER_Y, SLIDER_WIDTH, SLIDER_HEIGHT, {
            density: 0.05,
            frictionAir: 0.1,
            label: 'Slider',
            render: { fillStyle: '#D9534F' } // Red
        });

        // --- Create Constraints (Joints) ---

        // J1: Crank Pivot (Revolute Joint - Ground to Crank)
        const crankPivot = Constraint.create({
            pointA: { x: PIVOT_X, y: PIVOT_Y }, // Fixed world position
            bodyB: crank,
            pointB: { x: -CRANK_RADIUS, y: 0 }, // Point on the crank body
            stiffness: 1,
            length: 0,
            render: { visible: false } // Hide the constraint line
        });

        // J2: Crank to Connecting Rod (Revolute Joint)
        const crankRodJoint = Constraint.create({
            bodyA: crank,
            pointA: { x: CRANK_RADIUS, y: 0 }, // Other end of the crank
            bodyB: connectingRod,
            pointB: { x: -CONNECTING_ROD_LENGTH / 2, y: 0 }, // Left end of the rod
            stiffness: 1,
            length: 0,
            render: { strokeStyle: '#333' }
        });

        // J3: Connecting Rod to Slider (Revolute Joint)
        const rodSliderJoint = Constraint.create({
            bodyA: connectingRod,
            pointA: { x: CONNECTING_ROD_LENGTH / 2, y: 0 }, // Right end of the rod
            bodyB: slider,
            pointB: { x: 0, y: 0 }, // Center of the slider
            stiffness: 1,
            length: 0,
            render: { strokeStyle: '#333' }
        });

        // --- Prismatic Joint Simulation (Slider) ---

        // Constraint the slider's Y-position and angle after each physics update.
        Events.on(engine, 'afterUpdate', function() {
            // Lock the Y position to the SLIDER_Y centerline
            Body.setPosition(slider, {
                x: slider.position.x,
                y: SLIDER_Y
            }, true); // The 'true' infers velocity from the position change

            // Lock the rotation (angle) to 0
            Body.setAngle(slider, 0);
            Body.setAngularVelocity(slider, 0); // Stop any rotational drift
        });

        // --- Add all parts to the World ---
        World.add(world, [
            pivot,
            crank,
            connectingRod,
            slider,
            crankPivot,
            crankRodJoint,
            rodSliderJoint
        ]);

        // --- Add Interactivity (Mouse Constraint) ---

        const mouse = Mouse.create(render.canvas),
              mouseConstraint = MouseConstraint.create(engine, {
                mouse: mouse,
                constraint: {
                    stiffness: 0.2,
                    render: {
                        visible: false
                    }
                }
            });

        World.add(world, mouseConstraint);

        // Keep the mouse coordinates in sync with the renderer scale (optional)
        render.mouse = mouse;

        // --- Initial Drive (Optional: Auto-Run) ---
        // Apply a small constant torque to the crank to start the motion.
        Events.on(engine, 'beforeUpdate', function(event) {
            // Apply a torque to the crank to drive the mechanism
            // This force is very small and applied to the center of the body
            Body.applyForce(crank, crank.position, {
                x: 0.0001,
                y: 0.0001
            });
        });

    </script>
</body>
</html>
